const { addKeysToData, addDraftDataFromExistingDraft } = require('../utils/handlerUtils')
const { isDraftActivateAction } = require('../utils/draftUtils')

/**
 * Generic Handler for before UPDATE requests.
 *
 * @alias module:handlers.beforeUpdateDraft
 */
const beforeUpdateDraft = service => async context => {
  if (isDraftActivateAction(context)) {
    return
  }

  addKeysToData(context.data, context.target, true)

  const result = await addDraftDataFromExistingDraft(context, service)

  // means that draft not exists
  if (result.length === 0) {
    context.reject(404)
    return
  }

  context.isDraftChange = true
  context.draft = context.draftMetadata && context.draftMetadata.DraftUUID // deprecated
}

module.exports = beforeUpdateDraft
